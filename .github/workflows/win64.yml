name: Build Windows RDKit 

on:
  push:
    branches:
      - master

env:
  version: 2025_09_3
  BOOST_VERSION: 1.81.0
  BOOST_NAME: boost_1_81_0
  BOOST_ROOT: C:\boost_1_81_0
  
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  Windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Download source code
        run: |
          choco install curl wget ninja -y
          wget https://github.com/rdkit/rdkit/archive/Release_${{env.version}}.tar.gz
          tar -xf Release_${{env.version}}.tar.gz
   
      - name: Configure build for amd64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64
          toolset: 14.29  

      - name: Install Boost
        shell: pwsh
        run: |
         curl.exe -L https://zlib.net/fossils/zlib-1.2.11.tar.gz -o zlib-1.2.11.tar.gz
         curl.exe -L https://sourceware.org/pub/bzip2/bzip2-1.0.6.tar.gz -o bzip2-1.0.6.tar.gz
         curl.exe -L https://sourceforge.net/projects/boost/files/boost/${{env.BOOST_VERSION}}/${{env.BOOST_NAME}}.tar.gz/download -o ${{env.BOOST_NAME}}.tar.gz
         tar -xzf zlib-1.2.11.tar.gz
         tar -xzf bzip2-1.0.6.tar.gz
         tar -xzf ${{env.BOOST_NAME}}.tar.gz

         Copy-Item -Path "${{env.BOOST_NAME}}\"  -Destination "$env:BOOST_ROOT" -Recurse -Force
         Copy-Item -Path "zlib-1.2.11\"          -Destination "$env:BOOST_ROOT\zlib-1.2.11\" -Recurse -Force
         Copy-Item -Path "bzip2-1.0.6\"          -Destination "$env:BOOST_ROOT\bzip2-1.0.6\" -Recurse -Force
         cd ${{env.BOOST_ROOT}}
         dir
         
         .\bootstrap.bat --without-icu
         .\b2 --clean-all
         .\b2 install --prefix=${{env.BOOST_ROOT}} address-model=64 architecture=x86 toolset=msvc-14.2 threading=multi variant=release `
              runtime-link=static link=static `
              --disable-icu --disable-python `
              --with-thread `
              --with-serialization `
              --with-iostreams `
              --with-regex `
              --with-system `
              --with-program_options `
              -sBZIP2_SOURCE=${{ github.workspace }}\bzip2-1.0.6 `
              -sZLIB_SOURCE=${{ github.workspace }}\zlib-1.2.11 `
              -sNO_LZMA=1
     
      - name: Configure build for amd64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64
          toolset: 14.29
      
      - name: Bulid RDKit
        shell: pwsh
        run: |
          dir ${{env.BOOST_ROOT}}
          cd rdkit-Release_${{env.version}}
          md build && cd build
          cmake .. -DRDK_BUILD_PYTHON_WRAPPERS=OFF `
                   -DRDK_BUILD_FREETYPE_SUPPORT=OFF `
                   -DBoost_USE_STATIC_LIBS=ON `
                   -DBoost_USE_STATIC_RUNTIME=ON `
                   -DCMAKE_BUILD_TYPE=Release `
                   -DBoost_ROOT=${{env.BOOST_ROOT}} `
                   -G Ninja
                
          sed -i 's/-MD/-MT/g' build.ninja
          ninja install -j4 || ninja install -j1
          dir lib\
          Copy-Item -Path ".\lib\"         -Destination "C:\RDKit_Win64_Static\lib" -Recurse
          Copy-Item -Path "..\Code\"       -Destination "C:\RDKit_Win64_Static\Code" -Recurse
        
      - name: Upload RDKit
        uses: actions/upload-artifact@v4
        if: ${{ success() }}
        with:
          name: RDKit_Win64_Static
          path: |
            C:\RDKit_Win64_Static

  # refer to https://github.com/endless-sky/endless-sky/blob/master/.github/workflows/cd.yaml
  Release:
    needs: [Windows]
    runs-on: ubuntu-latest

    env:
        RELEASE_COMMAND: release
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RELEASE_TAG: bleed

    steps:
      - uses: actions/checkout@v4

      - name: Install github-release
        run: |
          go install github.com/github-release/github-release@latest
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      
      - name: Set environment variables
        run: |
          echo "RELEASE_TAG=bleed" >> $GITHUB_ENV
          echo "TIME=$(date -u '+%Y.%m.%d')" >> $GITHUB_ENV
          echo "GITHUB_USER=$( echo ${{ github.repository }} | cut -d/ -f1 )" >> $GITHUB_ENV
          echo "GITHUB_REPO=$( echo ${{ github.repository }} | cut -d/ -f2 )" >> $GITHUB_ENV

      - name: Move/Create continuous tag
        run: |
          git tag --force ${{ env.RELEASE_TAG }} ${{ github.sha }}
          git push --tags --force
      
      - name: Check continuous release status
        run: |
          if ! github-release info -t ${{ env.RELEASE_TAG }} > /dev/null 2>&1; then
            echo "RELEASE_COMMAND=release" >> $GITHUB_ENV
          else
            echo "RELEASE_COMMAND=edit" >> $GITHUB_ENV
          fi
      
      - name: Setup continuous release
        run: |
          DESCRIPTION="Triggered on $(date -u '+%Y/%m/%d, %H:%M') UTC by commit ${{ github.sha }} (@${{ github.actor }})
          This is an automated build of the latest source. It may be unstable or even crash, corrupt your save or eat your kitten. Use with caution!
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          github-release ${{env.RELEASE_COMMAND}} --tag ${{ env.RELEASE_TAG }} --name "Bleed Release" --description "$DESCRIPTION" --pre-release
      
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: RDKit_Win64_Static
          path: RDKit_Win64_Static

      - name: Package Windows artifact to release
        run: |
          ls -alt
          # time stamp
          OUTPUT_TAR=RDKit_Win64_Static.tar.gz
          tar -cvf ${OUTPUT_TAR} RDKit_Win64_Static
          github-release upload --tag ${{ env.RELEASE_TAG }} --replace --name ${OUTPUT_TAR} --file ${OUTPUT_TAR}

